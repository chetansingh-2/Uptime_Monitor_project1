{% extends 'base.html' %}
{% load static %}

{% block content %}
{# The main container uses responsive padding: smaller on mobile, larger on desktops. #}
<div class="w-full bg-slate-900 min-h-screen p-4 sm:p-6 md:p-8">

    {# A max-width container keeps content from becoming too wide on large screens, improving readability. #}
    <div class="max-w-7xl mx-auto">
        {# HEADER: Stacks vertically on mobile (flex-col) and becomes a row on larger screens (sm:flex-row). #}
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 md:mb-8 gap-4">
            {# Responsive font size for the main title. #}
            <h1 class="text-2xl sm:text-3xl font-bold text-white self-start sm:self-center">My Monitors</h1>
            
            {# This container also stacks its items until the `xs` breakpoint. `w-full` on mobile makes buttons take up the full width for easier tapping. #}
            <div class="flex flex-col xs:flex-row items-center gap-3 w-full sm:w-auto">
                <a href="{% url 'website-add' %}" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors duration-200 shadow-lg hover:shadow-sky-700/50 w-full xs:w-auto text-center">
                    Add New Site
                </a>
                
                {# User info and logout button group. #}
                <div class="flex items-center justify-between xs:justify-start w-full xs:w-auto gap-4 mt-2 xs:mt-0">
                    <div class="flex items-center space-x-2 text-slate-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="font-medium text-sm sm:text-base">{{ request.user.username }}</span>
                    </div>
                    <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="bg-slate-800 text-slate-200 px-3 sm:px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors duration-200 shadow-lg hover:shadow-slate-700/50 text-sm sm:text-base">Log Out</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# CONTENT AREA: Also constrained for readability. #}
    <div class="max-w-7xl mx-auto">
        {% if websites %}
            {# GRID: Stacks cards vertically by default (flex-col), then switches to a grid layout on `sm` screens and up, adjusting columns for larger screens. #}
            <div class="flex flex-col gap-6 sm:grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 sm:gap-6">
                {% for website in websites %}
                    {% with latest_check=website.get_latest_check sparkline_json=website.get_sparkline_json %}
                        
                        {# CARD: These classes create the card itself. min-h-[310px] ensures cards have a consistent minimum height. #}
                        <div class="bg-slate-800 rounded-xl p-5 flex flex-col transition-all duration-300 hover:-translate-y-1 border border-slate-700 min-h-[310px]
                            {% if latest_check and latest_check.is_up %}
                                hover:shadow-2xl hover:shadow-emerald-500/30
                            {% elif latest_check %}
                                hover:shadow-2xl hover:shadow-rose-500/30
                            {% else %}
                                hover:shadow-2xl hover:shadow-slate-500/30
                            {% endif %}">
                            
                            {# Card Header section #}
                            <div class="flex-shrink-0">
                                <div class="flex justify-between items-start mb-4">
                                    <h2 class="text-lg font-semibold text-white pr-3 leading-tight flex-1">{{ website.name }}</h2>
                                    <div class="w-3 h-3 mt-1 rounded-full shrink-0
                                        {% if latest_check and latest_check.is_up %} bg-emerald-400
                                        {% elif latest_check %} bg-rose-400
                                        {% else %} bg-slate-500 {% endif %}">
                                    </div>
                                </div>
                                <p class="text-slate-400 text-sm break-all leading-relaxed mb-4">{{ website.url }}</p>
                            </div>
                            
                            {# Sparkline Chart Container #}
                            <div class="mb-4 h-[80px]">
                                {% if sparkline_json != "[]" %}
                                    <div class="sparkline-chart" data-sparkline='{{ sparkline_json }}'
                                         data-color="{% if latest_check.is_up %}#34d399{% else %}#f43f5e{% endif %}"></div>
                                {% else %}
                                    <div class="h-full text-slate-400 text-sm flex items-center justify-center rounded-lg border-2 border-dashed border-slate-700">No recent data</div>
                                {% endif %}
                            </div>
                            
                            {# This `mt-auto` pushes the footer to the bottom of the card, thanks to `flex-col` on the parent. #}
                            <div class="mt-auto">
                                {# Stacks vertically on mobile, becomes a row on `sm` screens. `min-h-[20px]` prevents layout shift if data is missing. #}
                                <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center text-sm text-slate-400 mb-4 min-h-[20px]">
                                    <div class="flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-slate-300 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <span>{{ latest_check.timestamp|timesince|default:"Not yet checked." }}</span>
                                    </div>
                                    {% if latest_check %}
                                        <span class="font-mono text-slate-300 self-start sm:self-auto">{{ latest_check.response_time|floatformat:3 }}s</span>
                                    {% endif %}
                                </div>
                                
                                {# Action links at the bottom of the card #}
                                <div class="flex justify-start gap-6 border-t border-slate-700 pt-4 text-sm">
                                    <a href="{% url 'website-detail' pk=website.pk %}" class="font-semibold text-sky-400 hover:text-sky-300 transition-colors">Details</a>
                                    <a href="{% url 'website-update' pk=website.pk %}" class="text-slate-400 hover:text-slate-300 transition-colors">Edit</a>
                                    <a href="{% url 'website-delete' pk=website.pk %}" class="text-rose-400 hover:text-rose-300 transition-colors">Delete</a>
                                </div>
                            </div>
                        </div>
                    {% endwith %}
                {% endfor %}
            </div>
        {% else %}
            {# Empty state message with responsive text sizes. #}
            <div class="text-center py-20 px-4">
                <h2 class="text-xl sm:text-2xl font-semibold text-white mb-2">No websites are being monitored yet.</h2>
                <p class="text-slate-400 sm:text-base">Click the "Add New Site" button to get started!</p>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // This function sets up a single ApexChart.
            const setupChart = (el) => {
                // Do nothing if the element is missing or already has a chart.
                if (!el || el._chart) return;

                const chartData = JSON.parse(el.dataset.sparkline || '[]');
                if (chartData.length === 0) return;

                const chartColor = el.dataset.color || '#94a3b8';
                // Ensure chart has a height, even if the container is momentarily 0.
                const containerHeight = el.offsetHeight > 0 ? el.offsetHeight : 80;

                const options = {
                    chart: { 
                        type: 'area', 
                        height: containerHeight, 
                        sparkline: { enabled: true }, 
                        background: 'transparent', 
                        animations: { enabled: true, easing: 'easeinout', speed: 400, animateGradually: { enabled: false } }
                    },
                    stroke: { curve: 'smooth', width: 2 },
                    fill: { type: 'gradient', gradient: { shade: 'dark', type: 'vertical', opacityFrom: 0.6, opacityTo: 0.1, stops: [0, 100] }},
                    series: [{ name: 'Response Time', data: chartData }],
                    colors: [chartColor],
                    tooltip: { 
                        enabled: true, 
                        theme: 'dark', 
                        style: { fontSize: '12px' }, 
                        y: { formatter: (val) => val.toFixed(3) + 's' }
                    }
                };
                
                const chart = new ApexCharts(el, options);
                chart.render();
                // Store chart instance on the element for easy cleanup.
                el._chart = chart;
            };
            
            // This function finds all sparkline elements and renders/re-renders them.
            const renderAllCharts = () => {
                document.querySelectorAll('.sparkline-chart').forEach(el => {
                    // Destroy existing chart instance before re-rendering to prevent memory leaks.
                    if (el._chart) {
                        el._chart.destroy();
                        el._chart = null;
                    }
                    setupChart(el);
                });
            };

            // Initial render
            renderAllCharts();
            
            // Re-render charts on window resize, but "debounce" it to avoid excessive function calls.
            // This is a crucial performance optimization.
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(renderAllCharts, 250);
            });
        });
    </script>

</div>
{% endblock %}